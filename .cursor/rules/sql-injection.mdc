---
title: SQL Injection Prevention Rules
description: Rules and best practices to prevent SQL injection vulnerabilities
version: 1.0.0
created: 2025-10-21
status: active
alwaysApply: true
---

# SQL Injection Prevention Rules

## Overview
SQL injection is a critical security vulnerability that allows attackers to manipulate database queries by injecting malicious SQL code through user inputs. This rule file provides mandatory guidelines to prevent SQL injection vulnerabilities in all database interactions.

## ‚ö†Ô∏è CRITICAL REQUIREMENTS

### 1. ALWAYS Use Parameterized Queries (Prepared Statements)

**NEVER concatenate user input directly into SQL queries.** Always use parameterized queries with prepared statements.

#### ‚ùå VULNERABLE CODE (DO NOT USE):
```java
// DANGEROUS - vulnerable to SQL injection
String sql = "SELECT * FROM users WHERE username = '" + username + "' AND password = '" + password + "'";
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery(sql);
```

#### ‚úÖ SECURE CODE (ALWAYS USE):
```java
// SAFE - uses prepared statements with parameterized queries
PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE username = ? AND password = ?");
stmt.setString(1, username);
stmt.setString(2, password);
ResultSet rs = stmt.executeQuery();
```

### 2. Use PreparedStatement for ALL Database Operations

**For ALL SQL operations (SELECT, INSERT, UPDATE, DELETE), ALWAYS use PreparedStatement:**

#### INSERT Operations:
```java
// CORRECT
PreparedStatement stmt = conn.prepareStatement(
    "INSERT INTO users (username, email) VALUES (?, ?)"
);
stmt.setString(1, username);
stmt.setString(2, email);
stmt.executeUpdate();
```

#### UPDATE Operations:
```java
// CORRECT
PreparedStatement stmt = conn.prepareStatement(
    "UPDATE accounts SET balance = balance - ? WHERE id = ?"
);
stmt.setBigDecimal(1, amount);
stmt.setLong(2, accountId);
stmt.executeUpdate();
```

#### DELETE Operations:
```java
// CORRECT
PreparedStatement stmt = conn.prepareStatement(
    "DELETE FROM sessions WHERE user_id = ?"
);
stmt.setLong(1, userId);
stmt.executeUpdate();
```

### 3. Dynamic Query Building

If you must build dynamic queries (e.g., for search filters), use PreparedStatement with careful parameter handling:

#### ‚úÖ CORRECT Approach:
```java
StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE 1=1");
List<Object> params = new ArrayList<>();
int paramIndex = 1;

if (username != null && !username.isEmpty()) {
    sql.append(" AND username = ?");
    params.add(username);
}

if (email != null && !email.isEmpty()) {
    sql.append(" AND email = ?");
    params.add(email);
}

PreparedStatement stmt = conn.prepareStatement(sql.toString());
for (int i = 0; i < params.size(); i++) {
    stmt.setObject(i + 1, params.get(i));
}

ResultSet rs = stmt.executeQuery();
```

### 4. Type-Safe Parameter Binding

Always use type-specific setter methods for PreparedStatement:

```java
stmt.setString(1, stringValue);      // For String
stmt.setInt(2, intValue);            // For int
stmt.setLong(3, longValue);          // For long
stmt.setBigDecimal(4, decimalValue); // For BigDecimal
stmt.setTimestamp(5, timestamp);     // For Timestamp
stmt.setBoolean(6, booleanValue);    // For boolean
```

### 5. NEVER Use String Concatenation for SQL

**Prohibited patterns that MUST be avoided:**

```java
// ‚ùå NEVER DO THIS
"WHERE id = " + userId
"VALUES (" + value1 + ", '" + value2 + "')"
"SET name = '" + name + "'"
"AND status = '" + status + "'"
"LIKE '%" + searchTerm + "%'"
```

**Instead, always use:**

```java
// ‚úÖ CORRECT APPROACH
"WHERE id = ?"
"VALUES (?, ?)"
"SET name = ?"
"AND status = ?"
"LIKE ?"  // and pass "%" + searchTerm + "%" as parameter
```

## üõ°Ô∏è Additional Security Measures

### 1. Input Validation
Even when using prepared statements, validate all user inputs:
- Check data types and formats
- Enforce length limits
- Validate against whitelists where applicable
- Reject unexpected characters in structured fields

### 2. Principle of Least Privilege
- Database users should have minimal necessary permissions
- Use separate database accounts for different operations
- Never use root/admin accounts in application code

### 3. Error Handling
- Never expose SQL error messages to users
- Log detailed errors securely for debugging
- Return generic error messages to end users

### 4. ORM Usage
Consider using Object-Relational Mapping (ORM) frameworks that handle parameterization automatically:
- JPA/Hibernate
- Spring Data JPA
- MyBatis with proper parameter handling

## üìã Code Review Checklist

Before committing any database code, verify:
- [ ] All SQL queries use PreparedStatement
- [ ] No string concatenation in SQL statements
- [ ] All user inputs are parameterized
- [ ] Type-appropriate setters are used
- [ ] Dynamic queries properly handle parameters
- [ ] No raw Statement objects are used
- [ ] Error messages don't expose SQL structure

## üö® Common Vulnerable Patterns to Avoid

1. **String building with + operator**
   ```java
   "SELECT * FROM table WHERE field = '" + userInput + "'"
   ```

2. **String.format() for SQL**
   ```java
   String.format("SELECT * FROM table WHERE id = %s", id)
   ```

3. **StringBuilder/StringBuffer concatenation**
   ```java
   StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE ");
   sql.append("username = '").append(username).append("'");
   ```

4. **Statement.executeQuery() with concatenated strings**
   ```java
   Statement stmt = conn.createStatement();
   stmt.executeQuery("SELECT * FROM users WHERE id = " + userId);
   ```

## üîç Testing for SQL Injection

Test all input fields with common SQL injection payloads:
- `' OR '1'='1`
- `'; DROP TABLE users; --`
- `1' UNION SELECT NULL, NULL--`
- `admin'--`

All properly parameterized queries should safely handle these inputs without executing malicious code.

## üìö References

- OWASP SQL Injection: https://owasp.org/www-community/attacks/SQL_Injection
- CWE-89: SQL Injection: https://cwe.mitre.org/data/definitions/89.html
- Java PreparedStatement: https://docs.oracle.com/javase/tutorial/jdbc/basics/prepared.html

## üéØ Enforcement

This rule is **ALWAYS APPLIED** and violations must be corrected before code review approval. Any code containing SQL injection vulnerabilities will be rejected and must be refactored using prepared statements.

---

**Last Updated:** 2025-10-21  
**Rule Status:** Active and Enforced  
**Applies To:** All Java/JDBC code, database interactions
